version: '3.8'

services:
  # ============================================
  # PostgreSQL Master (Primary)
  # ============================================
  postgres-master:
    image: bitnami/postgresql:16
    container_name: place-info-postgres-master
    environment:
      # Replication settings
      - POSTGRESQL_REPLICATION_MODE=master
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      # Database settings
      - POSTGRESQL_USERNAME=${DB_USERNAME:-placeuser}
      - POSTGRESQL_PASSWORD=${DB_PASSWORD}
      - POSTGRESQL_DATABASE=${DB_NAME:-place}
      # Performance tuning
      - POSTGRESQL_EXTRA_FLAGS=-c max_connections=200 -c shared_buffers=256MB -c effective_cache_size=768MB
    volumes:
      - postgres-master-data:/bitnami/postgresql
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - place-info-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-placeuser} -d ${DB_NAME:-place}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # PostgreSQL Slave (Read Replica)
  # ============================================
  postgres-slave:
    image: bitnami/postgresql:16
    container_name: place-info-postgres-slave
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      # Replication settings
      - POSTGRESQL_REPLICATION_MODE=slave
      - POSTGRESQL_MASTER_HOST=postgres-master
      - POSTGRESQL_MASTER_PORT_NUMBER=5432
      - POSTGRESQL_REPLICATION_USER=repl_user
      - POSTGRESQL_REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      - POSTGRESQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres-slave-data:/bitnami/postgresql
    networks:
      - place-info-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-placeuser}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ============================================
  # Place Info Server (Application)
  # ============================================
  place-info-server:
    container_name: place-info-server
    image: ddingsh9/placeinfoserver:${APP_VERSION:-latest}
    depends_on:
      postgres-master:
        condition: service_healthy
    networks:
      - place-info-network
      - infra-network
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=prod

      # Server Port
      - SERVER_PORT=8080

      # PostgreSQL Configuration (Master for writes)
      - DB_HOST=postgres-master
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-place}
      - DB_USERNAME=${DB_USERNAME:-placeuser}
      - DB_PASSWORD=${DB_PASSWORD}

      # Kafka Configuration (from infra-network)
      - KAFKA_BROKER1=${KAFKA_BROKER1:-kafka1:9091}
      - KAFKA_BROKER2=${KAFKA_BROKER2:-kafka2:9092}
      - KAFKA_BROKER3=${KAFKA_BROKER3:-kafka3:9093}

      # Redis Configuration (from infra-network)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # Distributed Tracing
      - ZIPKIN_ENDPOINT=${ZIPKIN_ENDPOINT:-http://zipkin:9411/api/v2/spans}
      - TRACING_SAMPLING_PROBABILITY=${TRACING_SAMPLING_PROBABILITY:-0.1}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SQL_LOG_LEVEL=${SQL_LOG_LEVEL:-WARN}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # Nginx (Reverse Proxy / Load Balancer)
  # ============================================
  nginx:
    container_name: place-info-nginx
    image: nginx:alpine
    ports:
      - "${NGINX_PORT:-9412}:80"
    networks:
      - place-info-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      place-info-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Log Cleaner (Utility)
  # ============================================
  log-cleaner:
    image: alpine:latest
    container_name: place-info-log-cleaner
    volumes:
      - nginx-logs:/var/log/nginx
    entrypoint: /bin/sh
    command: >
      -c "while true; do
        find /var/log/nginx -name '*.log' -mtime +7 -delete;
        sleep 86400;
      done"
    restart: unless-stopped

# ============================================
# Volumes
# ============================================
volumes:
  postgres-master-data:
    name: place-info-postgres-master-data
  postgres-slave-data:
    name: place-info-postgres-slave-data
  nginx-logs:
    name: place-info-nginx-logs

# ============================================
# Networks
# ============================================
networks:
  place-info-network:
    driver: bridge
    name: place-info-network
  infra-network:
    external: true
    name: infra-network
